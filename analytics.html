<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>

        :root {
            --sidebar-w: 260px;
        }
        :root[data-theme="light"] {
            --bg:#ffffff;--card:#f6f8fa;--border:#d0d7de;--accent:#00884d;
            --accent2:#006637;--text:#24292f;--muted:#57606a;
            --fake:#d93025;--genuine:#137333;
        }
        :root[data-theme="dark"]{--bg:#0d1117;--card:#161b22;--border:#30363d;--accent:#00ff99;--accent2:#00cc7a;--text:#e6edf3;--muted:#8b949e;--fake:#ff5555;--genuine:#00ff99;}
        /* Light mode sidebar overrides */
        [data-theme="light"] .sidebar{background:#f6f8fa;border-right:1px solid #d0d7de;}
        [data-theme="light"] .logo-area h3{color:#00884d;}
        [data-theme="light"] .logo-area .icon{color:#00884d;}
        [data-theme="light"] .theme-toggle{background:rgba(0,136,77,0.08);border-color:#00884d;color:#00884d;}
        [data-theme="light"] .theme-toggle:hover{background:rgba(0,136,77,0.15);}
        [data-theme="light"] .nav-link{color:#57606a;}
        [data-theme="light"] .nav-link:hover{background:rgba(0,136,77,0.09);color:#00884d;}
        [data-theme="light"] .nav-link.active{background:rgba(0,136,77,0.12);color:#00884d;}
        [data-theme="light"] .user-card{background:rgba(0,136,77,0.06);border-color:rgba(0,136,77,0.2);}
        [data-theme="light"] .role-pill{background:rgba(0,136,77,0.12);color:#00884d;}
        [data-theme="light"] .logout-btn{color:#d93025;}
        [data-theme="light"] .logout-btn:hover{background:rgba(217,48,37,0.08);}
        [data-theme="light"] .divider{background:#d0d7de;}
        /* Light mode main content */
        [data-theme="light"] .filter-card{background:#f6f8fa;border-color:#d0d7de;}
        [data-theme="light"] .filter-group input[type="date"]{background:#ffffff;border-color:#d0d7de;color:#24292f;}
        [data-theme="light"] .filter-group input[type="date"]:focus{border-color:#00884d;}
        [data-theme="light"] .quick-btn{background:rgba(0,136,77,0.08);border-color:rgba(0,136,77,0.2);color:#00884d;}
        [data-theme="light"] .quick-btn:hover{background:rgba(0,136,77,0.16);}
        [data-theme="light"] .scard{background:#f6f8fa;border-color:#d0d7de;}
        [data-theme="light"] .table-card{background:#f6f8fa;border-color:#d0d7de;}
        [data-theme="light"] thead th{color:#57606a;border-bottom-color:#d0d7de;}
        [data-theme="light"] tbody td{border-bottom-color:#e8ecef;}
        [data-theme="light"] tbody tr:hover td{background:rgba(0,0,0,0.02);}
        [data-theme="light"] .badge.fake{background:rgba(217,48,37,0.1);color:#d93025;}
        [data-theme="light"] .badge.genuine{background:rgba(0,136,77,0.1);color:#00884d;}
        [data-theme="light"] .mob-menu{background:#00884d;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
        .sidebar{position:fixed;left:0;top:0;width:var(--sidebar-w);height:100vh;background:var(--card);border-right:1px solid var(--border);padding:28px 18px;z-index:200;display:flex;flex-direction:column;gap:4px;overflow-y:auto;}
        .logo-area{text-align:center;margin-bottom:28px;}
        .logo-area .icon{font-size:38px;color:var(--accent);}
        .logo-area h3{font-size:16px;color:var(--accent);margin-top:8px;letter-spacing:1px;}
        .logo-area small{font-size:11px;color:var(--muted);}
        .theme-toggle{width:100%;padding:10px;background:rgba(0,255,153,0.08);border:1px solid var(--accent);color:var(--accent);border-radius:8px;cursor:pointer;margin-bottom:15px;font-size:13px;transition:all 0.2s;}
        .theme-toggle:hover{background:rgba(0,255,153,0.15);}

        .nav-link{display:flex;align-items:center;gap:11px;padding:11px 14px;border-radius:9px;color:var(--muted);text-decoration:none;font-size:14px;transition:background 0.18s,color 0.18s;}
        .nav-link i{width:17px;text-align:center;}
        .nav-link:hover{background:rgba(0,255,153,0.09);color:var(--accent);}
        .nav-link.active{background:rgba(0,255,153,0.14);color:var(--accent);font-weight:600;}
        .divider{height:1px;background:var(--border);margin:10px 0;}
        .bottom-area{margin-top:auto;}
        .user-card{background:rgba(0,255,153,0.06);border:1px solid rgba(0,255,153,0.18);border-radius:10px;padding:13px;margin-bottom:10px;}
        .user-card .uname{font-size:13px;font-weight:600;}
        .user-card .uname i{color:var(--accent);margin-right:6px;}
        .role-pill{display:inline-block;font-size:10px;padding:2px 8px;border-radius:20px;background:rgba(0,255,153,0.15);color:var(--accent);margin-top:5px;text-transform:uppercase;letter-spacing:0.5px;}
        .logout-btn{display:flex;align-items:center;gap:9px;padding:10px 14px;border-radius:8px;color:#ff5555;text-decoration:none;font-size:13px;transition:background 0.18s;}
        .logout-btn:hover{background:rgba(255,85,85,0.1);}
        .main{margin-left:var(--sidebar-w);padding:32px 28px;}
        .page-head{margin-bottom:26px;}
        .page-head h1{font-size:26px;font-weight:700;}
        .page-head p{color:var(--muted);font-size:14px;margin-top:5px;}
        /* Date filter */
        .filter-card{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:22px;margin-bottom:24px;display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap;}
        .filter-group{display:flex;flex-direction:column;gap:6px;}
        .filter-group label{font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;}
        .filter-group input[type="date"]{background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:9px 12px;font-size:13px;font-family:inherit;}
        .filter-group input[type="date"]:focus{outline:none;border-color:var(--accent);}
        .quick-btns{display:flex;gap:8px;flex-wrap:wrap;}
        .quick-btn{padding:8px 14px;background:rgba(0,255,153,0.08);border:1px solid rgba(0,255,153,0.2);color:var(--accent);border-radius:7px;font-size:12px;cursor:pointer;transition:background 0.2s;}
        .quick-btn:hover{background:rgba(0,255,153,0.18);}
        .apply-btn{padding:9px 20px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:transform 0.2s;}
        .apply-btn:hover{transform:translateY(-1px);}
        /* Stats row */
        .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-bottom:26px;}
        .scard{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:22px;display:flex;align-items:center;gap:16px;}
        .scard-icon{width:50px;height:50px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
        .scard-icon.blue{background:rgba(77,156,255,0.15);color:#4d9cff;}
        .scard-icon.red{background:rgba(255,85,85,0.15);color:var(--fake);}
        .scard-icon.green{background:rgba(0,255,153,0.15);color:var(--accent);}
        .scard-val{font-size:30px;font-weight:700;line-height:1;}
        .scard-lbl{font-size:12px;color:var(--muted);margin-top:4px;}
        /* Table */
        .table-card{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:24px;margin-bottom:24px;overflow-x:auto;}
        .card-hd{font-size:15px;font-weight:600;margin-bottom:18px;display:flex;align-items:center;gap:9px;}
        .card-hd i{color:var(--accent);}
        table{width:100%;border-collapse:collapse;}
        thead th{text-align:left;padding:9px 13px;font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border);}
        tbody td{padding:12px 13px;font-size:13px;border-bottom:1px solid rgba(48,54,61,0.5);vertical-align:middle;}
        tbody tr:last-child td{border-bottom:none;}
        tbody tr:hover td{background:rgba(255,255,255,0.02);}
        .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
        .badge.fake{background:rgba(255,85,85,0.15);color:var(--fake);}
        .badge.genuine{background:rgba(0,255,153,0.15);color:var(--accent);}
        .rev-text{max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;color:var(--muted);}
        .empty{text-align:center;padding:40px 20px;color:var(--muted);}
        .empty i{font-size:40px;color:var(--border);display:block;margin-bottom:12px;}
        .mob-menu{display:none;position:fixed;top:14px;left:14px;z-index:300;background:var(--accent);color:#000;border:none;border-radius:8px;width:40px;height:40px;align-items:center;justify-content:center;font-size:18px;cursor:pointer;}
        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:190;}
        .overlay.show{display:block;}
        @media(max-width:860px){.sidebar{transform:translateX(-100%);transition:transform 0.3s;}.sidebar.open{transform:translateX(0);}.main{margin-left:0;padding:20px 16px;padding-top:60px;}.mob-menu{display:flex!important;}.stats-row{grid-template-columns:1fr 1fr;}.filter-card{flex-direction:column;align-items:flex-start;}}
        @media(max-width:480px){.stats-row{grid-template-columns:1fr;}.main{padding:14px;padding-top:60px;}}
    </style>
</head>
<body>
<button class="mob-menu" id="menuBtn" onclick="toggleSidebar()"><i class="fa fa-bars"></i></button>
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="logo-area">
        <i class="fa fa-shield-alt icon"></i>
        <h3>FraudDetect</h3>
        <small>Review Analysis System</small>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fa fa-moon" id="themeIcon"></i>
        <span id="themeText">Dark Mode</span>
    </button>
    <a href="/dashboard" class="nav-link"><i class="fa fa-tachometer-alt"></i> Dashboard</a>
    <a href="/check" class="nav-link"><i class="fa fa-search"></i> Check Review</a>
    <a href="/history" class="nav-link"><i class="fa fa-history"></i> History</a>
    <a href="/analytics" class="nav-link active"><i class="fa fa-chart-line"></i> Analytics</a>
    {% if user_role == 'admin' %}
    <a href="/users" class="nav-link"><i class="fa fa-users"></i> User Management</a>
    {% endif %}
    <div class="divider"></div>
    <div class="bottom-area">
        <div class="user-card">
            <div class="uname"><i class="fa fa-user-circle"></i>{{ user_name if user_name else "User" }}</div>
            <span class="role-pill">{{ user_role if user_role else "user" }}</span>
        </div>
        <a href="/logout" class="logout-btn"><i class="fa fa-sign-out-alt"></i> Logout</a>
    </div>
</aside>

<main class="main">
    <div class="page-head">
        <h1><i class="fa fa-chart-line" style="color:var(--accent);margin-right:10px;"></i>Analytics Dashboard</h1>
        <p>Analyze fraud patterns with custom date ranges.</p>
    </div>

    <!-- Date Filter -->
    <div class="filter-card">
        <div class="filter-group">
            <label>From</label>
            <input type="date" id="startDate" value="{{ start_date }}">
        </div>
        <div class="filter-group">
            <label>To</label>
            <input type="date" id="endDate" value="{{ end_date }}">
        </div>
        <div class="filter-group">
            <label>Quick Select</label>
            <div class="quick-btns">
                <button class="quick-btn" onclick="setRange(7)">Last 7 Days</button>
                <button class="quick-btn" onclick="setRange(30)">Last 30 Days</button>
                <button class="quick-btn" onclick="setRange(90)">Last 90 Days</button>
            </div>
        </div>
        <button class="apply-btn" onclick="applyFilter()"><i class="fa fa-filter"></i> Apply</button>
    </div>

    <!-- Stats -->
    <div class="stats-row">
        <div class="scard">
            <div class="scard-icon blue"><i class="fa fa-clipboard-list"></i></div>
            <div><div class="scard-val" style="color:#4d9cff;">{{ total }}</div><div class="scard-lbl">Total Reviews</div></div>
        </div>
        <div class="scard">
            <div class="scard-icon red"><i class="fa fa-exclamation-triangle"></i></div>
            <div><div class="scard-val" style="color:var(--fake);">{{ fake }}</div><div class="scard-lbl">Fake Detected</div></div>
        </div>
        <div class="scard">
            <div class="scard-icon green"><i class="fa fa-check-circle"></i></div>
            <div><div class="scard-val" style="color:var(--accent);">{{ genuine }}</div><div class="scard-lbl">Genuine Found</div></div>
        </div>
    </div>

    <!-- User Activity Table -->
    <div class="table-card">
        <div class="card-hd"><i class="fa fa-users"></i> User Activity in Selected Period</div>
        {% if user_stats %}
        <table>
            <thead>
                <tr>
                    <th>User</th><th>Total Checks</th><th>Fake Found</th><th>Genuine Found</th><th>Detection Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for user, stats in user_stats.items() %}
                <tr>
                    <td><strong>{{ user }}</strong></td>
                    <td>{{ stats.total }}</td>
                    <td style="color:var(--fake);">{{ stats.fake }}</td>
                    <td style="color:var(--accent);">{{ stats.genuine }}</td>
                    <td>{{ "%.1f"|format((stats.fake / stats.total * 100) if stats.total > 0 else 0) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty"><i class="fa fa-users"></i><p>No user activity in this period.</p></div>
        {% endif %}
    </div>

    <!-- Reviews Table -->
    <div class="table-card">
        <div class="card-hd"><i class="fa fa-list"></i> Reviews in Selected Period ({{ total }} total)</div>
        {% if history %}
        <table>
            <thead>
                <tr><th>Time</th><th>Review</th><th>Result</th><th>Confidence</th><th>Checked By</th></tr>
            </thead>
            <tbody>
                {% for item in history[:50] %}
                <tr>
                    <td style="color:var(--muted);font-size:12px;white-space:nowrap;">{{ item.timestamp }}</td>
                    <td><span class="rev-text" title="{{ item.review }}">{{ item.review }}</span></td>
                    <td>
                        {% if item.is_fake %}
                        <span class="badge fake"><i class="fa fa-times-circle"></i> Fake</span>
                        {% else %}
                        <span class="badge genuine"><i class="fa fa-check-circle"></i> Genuine</span>
                        {% endif %}
                    </td>
                    <td style="color:var(--accent);font-weight:600;">{{ item.confidence }}%</td>
                    <td style="color:var(--muted);font-size:12px;">{{ item.checked_by }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if total > 50 %}
        <p style="text-align:center;margin-top:16px;color:var(--muted);font-size:13px;">Showing first 50 of {{ total }} reviews</p>
        {% endif %}
        {% else %}
        <div class="empty"><i class="fa fa-inbox"></i><p>No reviews in this period.</p></div>
        {% endif %}
    </div>
</main>

<script>
function setRange(days){
    var end=new Date(),start=new Date();
    start.setDate(start.getDate()-days);
    document.getElementById('endDate').value=end.toISOString().split('T')[0];
    document.getElementById('startDate').value=start.toISOString().split('T')[0];
}
function applyFilter(){
    var s=document.getElementById('startDate').value;
    var e=document.getElementById('endDate').value;
    if(!s||!e){alert('Please select both dates');return;}
    window.location.href='/analytics?start_date='+s+'&end_date='+e;
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('show');}
</script>

<script>
(function(){var s=localStorage.getItem('appTheme')||'dark';document.documentElement.setAttribute('data-theme',s);})();
function updateTheme(theme){var icon=document.getElementById('themeIcon');var text=document.getElementById('themeText');if(!icon||!text)return;if(theme==='dark'){icon.className='fa fa-sun';text.textContent='Light Mode';}else{icon.className='fa fa-moon';text.textContent='Dark Mode';}}
function toggleTheme(){var cur=document.documentElement.getAttribute('data-theme')||'dark';var next=cur==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',next);localStorage.setItem('appTheme',next);updateTheme(next);}
document.addEventListener('DOMContentLoaded',function(){updateTheme(localStorage.getItem('appTheme')||'dark');});
</script>
</body>
</html>